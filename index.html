<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cryptofolio ‚Äî Client‚ÄëSide Encrypt/Decrypt</title>
  <meta name="description" content="100% client-side encryption & decryption of files/folders with password-derived key. No uploads. Ready for GitHub Pages." />
  
  <!-- Minimal, clean styling (no build step) -->
  <style>
    :root{
      --bg: #0b1220;           /* deep navy */
      --panel: #111a2b;        /* slightly lighter */
      --ink: #e6eefc;          /* near-white */
      --muted: #9db0d1;        /* muted text */
      --accent: #4f8aff;       /* primary blue */
      --accent-2:#7bf1a8;      /* green accent */
      --danger: #ff6b6b;       /* danger */
      --card: rgba(255,255,255,0.06);
      --card-bright: rgba(255,255,255,0.12);
      --radius: 16px;
      --shadow: 0 8px 30px rgba(0,0,0,0.35);
    }
    *{box-sizing: border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, #18243a 0%, transparent 60%),
                  radial-gradient(1000px 500px at 120% 10%, #0e2b3e 0%, transparent 55%),
                  var(--bg);
      color: var(--ink);
    }
    header{
      max-width: 1100px; margin: 24px auto 0; padding: 16px 20px; display:flex; align-items:center; gap:16px;
    }
    .logo{width:42px; height:42px; border-radius:12px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow);}
    h1{font-size: 1.4rem; margin:0}
    .sub{color: var(--muted); font-size: 0.95rem}

    .wrap{max-width:1100px; margin:16px auto 80px; padding: 0 20px;}
    .card{
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .tabs{display:flex; gap:8px; padding:8px; background: var(--card-bright); border-radius: 999px; width: fit-content;}
    .tab{padding:10px 16px; border-radius:999px; cursor:pointer; color:var(--muted); border:1px solid transparent; user-select:none}
    .tab.active{background:#0e1930; color:var(--ink); border-color: rgba(255,255,255,0.08)}

    .panels{margin-top:16px}

    .grid{display:grid; grid-template-columns: 1.1fr 0.9fr; gap:16px}
    @media (max-width: 940px){ .grid{grid-template-columns: 1fr;}}

    .section{padding:16px}
    .title{font-weight:600; margin-bottom:8px}
    .muted{color:var(--muted); font-size:0.95rem}

    .dropzone{
      margin-top:12px; padding:22px; border:1px dashed rgba(255,255,255,0.25); border-radius:12px; text-align:center; transition: .25s border-color, .25s background;
    }
    .dropzone.drag{border-color: var(--accent); background: rgba(79,138,255,0.08)}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0 6px}
    button, .ghost{
      cursor:pointer; border:1px solid rgba(255,255,255,0.12); color:var(--ink); background:#0f1a2c; padding:10px 14px; border-radius:12px; font-weight:600; box-shadow: 0 2px 0 rgba(0,0,0,0.25);
    }
    button.primary{ background: linear-gradient(180deg, var(--accent), #376ef0); border-color: rgba(0,0,0,0.1)}
    button.good{ background: linear-gradient(180deg, var(--accent-2), #3ac27f); color:#001a0c}
    button.danger{ background: linear-gradient(180deg, #ff8c8c, var(--danger)); }

    input[type="password"], input[type="text"]{
      width:100%; padding:12px 14px; background:#0b1628; color:var(--ink); border:1px solid rgba(255,255,255,0.15); border-radius:12px; outline:none; font-size:0.98rem;
    }
    .row{display:flex; gap:10px; align-items:center}
    .grow{flex:1}

    .list{margin-top:12px; max-height:300px; overflow:auto; padding-right:6px}
    .file{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); margin-bottom:8px}
    .path{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .meta{color:var(--muted); font-size:0.9rem}

    .kbd{border:1px solid rgba(255,255,255,0.18); background:#0f1c31; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:0.85rem}

    .progress{height:10px; border-radius:999px; background: rgba(255,255,255,0.08); overflow:hidden}
    .bar{height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); transition: width .15s ease-out}

    footer{max-width:1100px; margin: 20px auto; padding:0 20px; color:var(--muted); font-size:0.9rem}
    a{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="logo" aria-hidden></div>
    <div>
      <h1>Cryptofolio</h1>
      <div class="sub">100% client‚Äëside encryption & decryption for files and folders (AES‚Äë256‚ÄëGCM + PBKDF2). No uploads. GitHub Pages‚Äëready.</div>
    </div>
  </header>

  <div class="wrap">
    <div class="tabs card">
      <div class="tab active" data-tab="enc">Encrypt</div>
      <div class="tab" data-tab="dec">Decrypt</div>
    </div>

    <div class="panels">
      <!-- ENCRYPT PANEL -->
      <section id="panel-enc" class="card section">
        <div class="grid">
          <div>
            <div class="title">1) Add files or folders</div>
            <div class="muted">Drag & drop anywhere, or use the buttons. Folder structure and timestamps are preserved in a ZIP before encryption.</div>

            <div class="btns">
              <label class="ghost"><input id="pick-files" type="file" multiple hidden />‚ûï Add Files</label>
              <label class="ghost"><input id="pick-folder" type="file" webkitdirectory directory multiple hidden />üìÅ Add Folder</label>
              <button id="clear-list" title="Clear selection">Clear</button>
            </div>

            <div id="drop-enc" class="dropzone">Drop files or folders here</div>
            <div class="list" id="list-enc"></div>
          </div>

          <div>
            <div class="title">2) Set password & options</div>
            <div class="row" style="margin: 10px 0 8px">
              <input id="password" type="password" placeholder="Password (keep it safe!)" class="grow" autocomplete="new-password" />
              <button id="toggle-pass" title="Show/Hide">üëÅÔ∏è</button>
            </div>
            <div class="row" style="gap: 16px">
              <div class="grow muted">Key stretch: <span id="iter-label">310,000</span> PBKDF2 iterations</div>
              <input id="iter" type="range" min="100000" max="600000" step="10000" value="310000"/>
            </div>

            <div style="margin: 16px 0 10px">
              <div class="muted">Progress</div>
              <div class="progress"><div id="prog-enc" class="bar"></div></div>
            </div>

            <div class="btns">
              <button id="encrypt" class="primary">üîê Encrypt to .secure</button>
              <button id="download-zip" class="ghost" title="Create plain ZIP (no encryption)">Zip only</button>
            </div>
            <div class="muted" style="margin-top:8px">All work happens in your browser. Nothing leaves your device.</div>
          </div>
        </div>
      </section>

      <!-- DECRYPT PANEL -->
      <section id="panel-dec" class="card section" style="display:none">
        <div class="grid">
          <div>
            <div class="title">1) Choose a .secure file</div>
            <div class="btns">
              <label class="ghost"><input id="pick-secure" type="file" accept=".secure,.enc,.bin" hidden />üì¶ Select .secure</label>
            </div>
            <div id="drop-dec" class="dropzone">Drop your .secure file here</div>
            <div class="list" id="list-dec"></div>
          </div>

          <div>
            <div class="title">2) Enter password</div>
            <div class="row" style="margin: 10px 0 8px">
              <input id="password-dec" type="password" placeholder="Password used for encryption" class="grow" autocomplete="current-password" />
              <button id="toggle-pass-dec" title="Show/Hide">üëÅÔ∏è</button>
            </div>

            <div style="margin: 16px 0 10px">
              <div class="muted">Progress</div>
              <div class="progress"><div id="prog-dec" class="bar"></div></div>
            </div>

            <div class="btns">
              <button id="decrypt" class="good">üîì Decrypt to .zip</button>
            </div>
            <div class="muted" style="margin-top:8px">Decryption yields the original ZIP with folder structure & timestamps.</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <footer>
    <p><strong>Security details</strong>: AES‚Äë256‚ÄëGCM with a key derived from your password using PBKDF2‚ÄëHMAC‚ÄëSHA‚Äë256 (configurable iterations, default 310k). Random 16‚Äëbyte salt and 12‚Äëbyte IV are generated per file. A small JSON header (with salt, IV, iterations, version) is prepended before ciphertext. Source is static and safe to host on GitHub Pages.</p>
  </footer>

  <!-- fflate: tiny ZIP library for browser. Using ESM from CDN. -->
  <script type="module">
    import { zipAsync, unzipAsync, strToU8 } from 'https://cdn.jsdelivr.net/npm/fflate@0.8.2/esm/browser.js';

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const enc = new TextEncoder();
    const dec = new TextDecoder();

    function bytesToHex(u8){ return [...u8].map(b=>b.toString(16).padStart(2,'0')).join(''); }

    function saveBlob(name, blob){
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 1000);
    }

    function prettyBytes(n){
      const u=['B','KB','MB','GB','TB'];
      let i=0; while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return `${n.toFixed(n<10&&i>0?2:1)} ${u[i]}`;
    }

    // ---------- Tab logic ----------
    $$('.tab').forEach(t=>t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const which = t.dataset.tab;
      $('#panel-enc').style.display = which==='enc'? 'block':'none';
      $('#panel-dec').style.display = which==='dec'? 'block':'none';
    }));

    // ---------- File collection (Encrypt) ----------
    let encFiles = []; // {file: File, path: string}

    function renderEncList(){
      const c = $('#list-enc'); c.innerHTML = '';
      if(encFiles.length===0){ c.innerHTML = '<div class="muted">No files selected yet.</div>'; return; }
      for(const it of encFiles){
        const row = document.createElement('div'); row.className='file';
        const left = document.createElement('div');
        left.innerHTML = `<div class="path">${it.path}</div><div class="meta">${prettyBytes(it.file.size)} ¬∑ mtime ${new Date(it.file.lastModified).toLocaleString()}</div>`;
        const del = document.createElement('button'); del.textContent = '‚úñ'; del.className='danger'; del.style.padding='6px 10px';
        del.onclick = ()=>{ encFiles = encFiles.filter(x=>x!==it); renderEncList(); };
        row.appendChild(left); row.appendChild(del);
        c.appendChild(row);
      }
    }

    function addEncFiles(newOnes){
      for(const f of newOnes){
        const rel = f.webkitRelativePath && f.webkitRelativePath.length>0 ? f.webkitRelativePath : f.name;
        encFiles.push({file:f, path: rel});
      }
      // de-dup by path + size + mtime
      const seen = new Set();
      encFiles = encFiles.filter(f=>{
        const k = `${f.path}|${f.file.size}|${f.file.lastModified}`;
        if(seen.has(k)) return false; seen.add(k); return true;
      });
      renderEncList();
    }

    // File inputs
    $('#pick-files').addEventListener('change', e=> addEncFiles(e.target.files));
    $('#pick-folder').addEventListener('change', e=> addEncFiles(e.target.files));
    $('#clear-list').addEventListener('click', ()=>{ encFiles = []; renderEncList(); });

    // Drag & Drop (supports folders via DataTransferItem.webkitGetAsEntry)
    async function traverseEntry(entry, path=''){ // Chrome/Edge/Safari
      return new Promise((resolve)=>{
        if(entry.isFile){
          entry.file(file=> resolve([{file, path: path+file.name}]) );
        } else if(entry.isDirectory){
          const dirReader = entry.createReader();
          const out=[];
          const read = ()=> dirReader.readEntries(async entries=>{
            if(!entries.length){ resolve(out); return; }
            for(const ent of entries){ out.push(...await traverseEntry(ent, path+entry.name+'/')); }
            read();
          });
          read();
        } else { resolve([]); }
      });
    }

    async function handleDnD(e, which){
      e.preventDefault();
      const dz = which==='enc'? $('#drop-enc') : $('#drop-dec');
      dz.classList.remove('drag');
      const items = e.dataTransfer.items;
      if(which==='enc'){
        const collected=[];
        if(items && items.length){
          for(const it of items){
            const entry = it.webkitGetAsEntry?.();
            if(entry){ collected.push(...await traverseEntry(entry)); }
            else { const f = it.getAsFile?.(); if(f) collected.push({file:f, path:f.name}); }
          }
        } else {
          const files = e.dataTransfer.files; for(const f of files) collected.push({file:f, path:f.name});
        }
        addEncFiles(collected.map(x=>Object.assign(x.file,{webkitRelativePath:x.path})) && collected.map(x=>x.file));
      } else {
        // decrypt: expect a single .secure file
        const files = e.dataTransfer.files;
        if(files && files.length){ decFile = files[0]; renderDecList(); }
      }
    }

    ;['dragenter','dragover'].forEach(ev=>{
      $('#drop-enc').addEventListener(ev, e=>{ e.preventDefault(); e.currentTarget.classList.add('drag'); });
      $('#drop-dec').addEventListener(ev, e=>{ e.preventDefault(); e.currentTarget.classList.add('drag'); });
    });
    ;['dragleave','drop'].forEach(ev=>{
      $('#drop-enc').addEventListener(ev, e=>{ e.preventDefault(); e.currentTarget.classList.remove('drag'); });
      $('#drop-dec').addEventListener(ev, e=>{ e.preventDefault(); e.currentTarget.classList.remove('drag'); });
    });
    $('#drop-enc').addEventListener('drop', e=> handleDnD(e,'enc'));
    $('#drop-dec').addEventListener('drop', e=> handleDnD(e,'dec'));

    // ---------- Password visibility ----------
    $('#toggle-pass').onclick = ()=>{ const i=$('#password'); i.type = i.type==='password'? 'text':'password'; };
    $('#toggle-pass-dec').onclick = ()=>{ const i=$('#password-dec'); i.type = i.type==='password'? 'text':'password'; };
    $('#iter').addEventListener('input', e=> $('#iter-label').textContent = (+e.target.value).toLocaleString());

    // ---------- Crypto core ----------
    const MAGIC = 'ENC1'; // 4 bytes ASCII at start

    async function deriveKey(password, salt, iterations){
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2', hash:'SHA-256', salt, iterations}, keyMaterial, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }

    function makeHeader({salt, iv, iterations}){
      const header = { v:1, algo:'AES-GCM', kdf:'PBKDF2-SHA256', salt: Array.from(salt), iv: Array.from(iv), iter: iterations };
      const bytes = enc.encode(JSON.stringify(header));
      const head = new Uint8Array(4 + 4 + bytes.length);
      head.set(enc.encode(MAGIC), 0); // magic
      // length (big-endian)
      const len = bytes.length; head[4]=(len>>>24)&255; head[5]=(len>>>16)&255; head[6]=(len>>>8)&255; head[7]=len&255;
      head.set(bytes, 8);
      return head;
    }

    function parseHeader(u8){
      const magic = dec.decode(u8.slice(0,4)); if(magic!==MAGIC) throw new Error('Invalid file: bad magic');
      const len = (u8[4]<<24) | (u8[5]<<16) | (u8[6]<<8) | (u8[7]);
      const headerBytes = u8.slice(8, 8+len);
      const h = JSON.parse(dec.decode(headerBytes));
      return { headerLength: 8+len, meta: h };
    }

    function setProgress(which, pct){ (which==='enc'? $('#prog-enc') : $('#prog-dec')).style.width = Math.max(0, Math.min(100, pct)) + '%'; }

    // ---------- ZIP helpers ----------
    async function zipFiles(files){
      // files: array of {file: File, path: string}
      const input = {};
      // Read as ArrayBuffers in sequence to avoid spikes; update progress
      let done=0;
      for(const {file, path} of files){
        const buf = new Uint8Array(await file.arrayBuffer());
        input[path] = [buf, {mtime: new Date(file.lastModified)}];
        done++;
        setProgress('enc', Math.round((done/files.length)*50)); // first half for staging
      }
      const zipped = await zipAsync(input, { level: 9, mem: 1, mtime: new Date(), consume: true, 
        onprogress: (bytes, total)=>{
          // second half for compression
          const base = 50; const pct = base + Math.round((bytes/total)*50);
          setProgress('enc', pct);
        }
      });
      return zipped; // Uint8Array
    }

    // ---------- Encrypt flow ----------
    $('#download-zip').onclick = async ()=>{
      if(encFiles.length===0) return alert('Add some files first.');
      try{
        const zip = await zipFiles(encFiles);
        saveBlob('bundle.zip', new Blob([zip], {type:'application/zip'}));
        setProgress('enc', 0);
      }catch(err){ console.error(err); alert('Zipping failed: '+err.message); setProgress('enc', 0); }
    };

    $('#encrypt').onclick = async ()=>{
      if(encFiles.length===0) return alert('Add some files or a folder first.');
      const password = $('#password').value;
      if(!password || password.length<6) return alert('Please enter a password (6+ characters recommended).');
      const iterations = +$('#iter').value;
      try{
        const zip = await zipFiles(encFiles);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(password, salt, iterations);
        const ct = new Uint8Array(await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, zip));
        const header = makeHeader({salt, iv, iterations});
        const out = new Uint8Array(header.length + ct.length);
        out.set(header, 0); out.set(ct, header.length);
        saveBlob('bundle.secure', new Blob([out], {type:'application/octet-stream'}));
        setProgress('enc', 0);
      }catch(err){ console.error(err); alert('Encryption failed: '+err.message); setProgress('enc', 0); }
    };

    // ---------- Decrypt flow ----------
    let decFile = null;

    function renderDecList(){
      const c = $('#list-dec'); c.innerHTML='';
      if(!decFile){ c.innerHTML = '<div class="muted">No .secure selected yet.</div>'; return; }
      const row = document.createElement('div'); row.className='file';
      row.innerHTML = `<div class="path">${decFile.name}</div><div class="meta">${prettyBytes(decFile.size)}</div>`;
      c.appendChild(row);
    }

    $('#pick-secure').addEventListener('change', e=>{ decFile = e.target.files?.[0] || null; renderDecList(); });

    $('#decrypt').onclick = async ()=>{
      if(!decFile) return alert('Select your .secure file first.');
      const password = $('#password-dec').value;
      if(!password || password.length<1) return alert('Enter the password used for encryption.');
      try{
        const u8 = new Uint8Array(await decFile.arrayBuffer());
        // parse header
        const { headerLength, meta } = parseHeader(u8);
        setProgress('dec', 10);
        const salt = new Uint8Array(meta.salt);
        const iv   = new Uint8Array(meta.iv);
        const key  = await deriveKey(password, salt, meta.iter);
        const ct   = u8.slice(headerLength);
        const plain = new Uint8Array(await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct));
        setProgress('dec', 70);
        // Optional: quick test unzip (to validate password) then re-save as zip
        // We won't extract files individually (browser cannot create folders);
        // instead we deliver the original ZIP to you.
        // Validate by touching central directory via unzipAsync
        await unzipAsync(plain, {}); // throws if corrupted/wrong pass
        setProgress('dec', 90);
        saveBlob(decFile.name.replace(/\.secure$|$/i, '.zip'), new Blob([plain], {type:'application/zip'}));
        setProgress('dec', 0);
      }catch(err){ console.error(err); alert('Decryption failed: '+err.message + '\n‚Ä¢ Check your password.'); setProgress('dec', 0); }
    };

    // Feature checks
    if(!('crypto' in window && crypto.subtle)){
      alert('Your browser does not support WebCrypto (SubtleCrypto). Use a modern Chromium, Firefox, or Safari.');
    }

    // Initial render
    renderEncList(); renderDecList();
  </script>
</body>
</html>
